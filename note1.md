# x86硬件

## x86运行模式
- 实模式
  - 80386加电启动后处于实模式运行状态，此状态可访问的物理
  内存不能超过1MB，且不能寻址4G。
- 保护模式
  - 支持分页机制，虚拟内存，多任务。

## 内存架构
- 物理内存地址空间
 - 是处理器提交到总线上用于访问计算机系统中内存和外设的
 最终地址，一个计算机只有一个物理地址空间
- 线性地址空间
 - 是在操作系统的虚存管理之下每个运行的app能访问的地址空间，
 每个app都认为自己独享整个计算机系统的地址空间，这样可以让
 多个运行的app之间相互隔离。
- 逻辑地址空间
 - 是app直接使用的地址空间
 
段机制启动，页机制未启动： 逻辑地址->*段机制处理*->线性地址=物理地址

段机制，页机制都启动： 逻辑地址->*段机制处理*->线性地址->*页机制处理*->物理地址

## 寄存器
- 通用寄存器
 - eax 累加器
 - ebx 基址寄存器
 - ecx 计数器
 - edx 数据寄存器
 - esi 源地址寄存器
 - edi 目的地址指针
 - ebp 基址指针
 - esp 堆栈指针寄存器
 
- 段寄存器
 - cs 代码段（code segment）
 - ds 数据段
 - es 附加数据段
 - ss 堆栈段
 - fs 附加段
 - gs 附加段
 
- 指令指针寄存器和标志寄存器
 - eip 低16位是ip，ip和cs一起能够访问实模式的1MB的地址空间
 在分段地址转换中，表示指令的段内偏移地址
 - eflags 
 
- 系统地址寄存器，调试寄存器...

# 启动、中断、异常和系统调用比较

## BIOS
 加电后，1Ｍ内存中的BIOS启动固件执行
 
 CS:IP,初始化后处于实模式
 
 PC = 16*CS + IP
 
 - 基本输入输出程序
 - 系统设置信息
 - 开机自检程序
 - 系统自启动程序
 
 
 将加载程序从磁盘的引导扇区（512字节）加载到0x7c00, 跳转到
 CS:IP = 0000:7C00
 
#### 加载程序
将操作系统的数据从硬盘加载到内存中

跳转到操作系统的起始位置

## BIOS初始化过程
- 硬件自检POST
- 检测系统中内存和显卡等关键部件的存在和工作状态
- 查找并执行显卡等接口卡BIOS，进行设备初始化；
- 执行系统BIOS，进行系统检测；
 - 检测和配置系统中安装的即插即用设备；
- 更新CMOS中的扩展系统配置数据ESCD
- 按指定启动顺序从软盘、硬盘或光驱启动

## 系统调用
应用程序主动向操作系统发出的服务请求

## 异常
非法指令或其他原因导致当前指令执行失败

异常服务例程可被打断，可嵌套

## 中断（hardware interrupt）
- 来自外部硬件设备的处理请求
- 异步的

### 中断嵌套
- 硬件中断服务例程可被打断


## 中断，异常处理机制
### 硬件处理
- 在CPU初始化时设置中断使能标志

### 软件
- 现场保护
- 中断服务处理
- 清楚中断标记
- 现场恢复

# bootloader 启动
## x86启动顺序－第一条指令
- CS = F000H, EIP = 0000FFF0H
- 指令的实际地址:

    Base + EIP = FFFF0000H + 0000FFF0H = FFFFFFFFH
    
    where is ERPOM of BIOS 
    
- 通常第一条指令是一条长跳转指令

## x86启动顺序－处于实模式的段

CS:IP

## x86启动顺序－从BIOS到bootloader
- BIOS加载存储设备上的第一个*扇区的512字节*（BMR）到内存的0x7c00..
 
 This MBR code is usually referred to as a boot loader
- 然后跳转到0x7c00的第一条指令开始执行

## x86启动顺序－从bootloader到OS
－bootloader做的事
  - 实模式的16位寻址空间切换到保护模式的32位寻址空间，即从1M到4G
    
    enable段机制  
  - 从硬盘上读取kernel并放到内存中固定位置
  - 跳转到OS的entry　point执行，这时控制权到了OS中